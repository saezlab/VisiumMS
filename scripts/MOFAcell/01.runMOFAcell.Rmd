---
title: "Multicellular programs"
author: "Ricardo Ramirez"
date: "2023-06-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(MOFAcellulaR)
library(tidyverse)
library(compositions)
```

```{r, echo=FALSE}
reticulate::use_condaenv(condaenv = "/Users/ricardoramirez/opt/miniconda3/envs/MOFA")
```

## Unsupervised analysis of MS lessions

### Importing data
```{r}
# Importing pb data
pb_data <- read_csv("./data/pb_data.csv", show_col_types = FALSE) %>%
  as.data.frame()
rownames(pb_data) <- gsub("_c", "c", pb_data[,1])
pb_data <- pb_data[, -1]
pb_data <- as.matrix(pb_data) %>% t()

# Importing coldata of the matrices
coldat <- read_csv("./data/pb_coldata.csv",
                   show_col_types = FALSE)[,-1] %>%
  dplyr::mutate(colname = gsub("_c", "c", colname)) %>%
  dplyr::mutate(cell_types = gsub("_c", "c", cell_types)) %>%
  column_to_rownames("colname") %>%
  dplyr::rename(cell_counts = "counts") %>%
  dplyr::rename(donor_id = "sample_id")

pb_data <- pb_data[,rownames(coldat)]
```

```{r}
meta <- read_csv("./data/meta_data.csv")[, -1]
```

### Importing markers

Defining background genes

```{r}
mrkr_genes <- read_csv("./data/edgeR_cellmrkrs.csv")

mrkr_genes <- mrkr_genes %>% #dplyr::filter(!name %in% exclude_ct) %>%
  dplyr::filter(FDR < 0.01, logFC > 1) %>%
  dplyr::select(name, gene) %>%
  dplyr::rename("lineage" = name) %>%
  group_by(lineage) %>%
  nest() %>%
  dplyr::mutate(data = map(data, ~.x[[1]])) %>%
  deframe()
```

QC_expression

```{r}
filt_samples_bycov <- function(pb_dat_list, prop_coverage = 0.9) {
  
  pb_dat_list_new <- map(pb_dat_list, function(pb_obj) {
    
    mat <- SummarizedExperiment::assay(pb_obj, "counts")
    
    sample_vect <- (mat != 0) %>% colSums(.)/nrow(mat)
    
    sel_samples <- names(sample_vect[which(sample_vect >= prop_coverage)])
    
    return(pb_obj[,sel_samples])
    
  })
  
  return(pb_dat_list_new)
}
```

### Defining MOFAcell data

```{r}
cts <- coldat$cell_types %>% unique()

# Do all processing of counts matrices
pb_dat_df <- MOFAcellulaR::create_init_exp(counts = pb_data[,rownames(coldat)],  
                                               coldata = coldat) %>%
  MOFAcellulaR::filt_profiles(pb_dat = .,
                          cts = cts,
                          ncells = 25,
                          counts_col = "cell_counts", 
                          ct_col = "cell_types") %>%
  MOFAcellulaR::filt_views_bysamples(pb_dat_list = .,
                                     nsamples = 10) %>%
  MOFAcellulaR::filt_gex_byexpr(pb_dat_list = .,
                                min.count = 25,
                                min.prop = 0.25) %>%
  MOFAcellulaR::filt_views_bygenes(pb_dat_list = .,
                                   ngenes = 50) %>%
  filt_samples_bycov(pb_dat_list = ., # Filtering of low quality samples
                     prop_coverage = 0.95) %>%
  MOFAcellulaR::tmm_trns(pb_dat_list = .,
                         scale_factor = 1000000) %>% 
  #MOFAcellulaR::filt_gex_byhvg(pb_dat_list = .,
  #                             prior_hvg = NULL,
  #                             var.threshold = 0) %>%
  MOFAcellulaR::filt_gex_bybckgrnd(pb_dat_list = .,
                                   prior_mrks = mrkr_genes) %>%
  MOFAcellulaR::filt_views_bygenes(pb_dat_list = .,
                                   ngenes = 50) %>%
  MOFAcellulaR::pb_dat2MOFA(pb_dat_list = .)
```

### Generating compositional view data
```{r}
cell_comps_raw <- coldat %>% dplyr::group_by(donor_id) %>%
  dplyr::mutate(all_cells = sum(cell_counts)) %>%
  ungroup() %>%
  dplyr::mutate(cell_props = cell_counts/all_cells) %>%
  dplyr::select(donor_id, cell_types, cell_props) %>%
  unique() %>%
  pivot_wider(names_from = cell_types, values_from = cell_props,values_fill = 0) %>%
  column_to_rownames("donor_id") %>%
  as.matrix()
  
cell_comps <- compositions::acomp(cell_comps_raw) %>%
  compositions::clr(.) %>% 
  as.data.frame(cell_comps) %>%
  rownames_to_column("sample") %>%
  pivot_longer(-sample, names_to = "feature", values_to = "value") %>%
  dplyr::mutate(view = "compositions") %>%
  dplyr::select(view, feature, sample, value)
```

### Plug it to the main views

```{r}
pb_dat_df <- bind_rows(pb_dat_df, cell_comps)
```

### RUN MOFA

```{r, message=FALSE}
MOFAobject <- create_mofa(pb_dat_df)

data_opts <- get_default_data_options(MOFAobject)

model_opts <- get_default_model_options(MOFAobject)

model_opts$num_factors <- 4

model_opts$spikeslab_weights <- FALSE

train_opts <- get_default_training_options(MOFAobject)

# Prepare MOFA model:
MOFAobject <- prepare_mofa(
  object = MOFAobject,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts
)

# Train model:
outfile <- file.path("./data/", "mofacell_complete.hdf5")

model <- run_mofa(MOFAobject, outfile)
```

```{r, fig.width = 4}
MOFA2::plot_data_overview(MOFAobject)
```

```{r, fig.width = 4}
pb_dat_df %>% 
  dplyr::select(view, sample) %>% 
  unique() %>% 
  group_by(sample) %>% 
  summarize(n_views = n()) %>%
  ggplot(aes(x = n_views, y = sample)) +
  geom_bar(stat="identity") +
  theme_classic()
```

## Associations across conditions

```{r}
meta <- meta %>%
  dplyr::mutate(disease = ifelse(lesion_type == "Ctrl", "Ctrl", "MS"))
```

### Disease MS vs rest

```{r}
expl_var_dis <- MOFAcellulaR::get_associations(model = model,
                                       metadata = meta  %>%
  dplyr::filter(sample_id != "MS466"),
                                        sample_id_column = "sample_id",
                                        test_variable = "disease",
                                        test_type = "categorical",
                                        categorical_type = "parametric",
                                        group = FALSE)

expl_var_dis
```

### Lession types

```{r}
expl_var_lession <- MOFAcellulaR::get_associations(model = model,
                                       metadata = meta %>%
                                         dplyr::filter(disease != "Ctrl",
                                                       sample_id != "MS466"),
                                        sample_id_column = "sample_id",
                                        test_variable = "lesion_type",
                                        test_type = "categorical",
                                        categorical_type = "parametric",
                                        group = FALSE)

expl_var_lession
```

### Sex

```{r}
expl_var_sex <- MOFAcellulaR::get_associations(model = model,
                                       metadata = meta,
                                        sample_id_column = "sample_id",
                                        test_variable = "Sex",
                                        test_type = "categorical",
                                        categorical_type = "parametric",
                                        group = FALSE)

expl_var_sex
```

### Age

```{r}
expl_var_age <- MOFAcellulaR::get_associations(model = model,
                                       metadata = meta,
                                        sample_id_column = "sample_id",
                                        test_variable = "Age",
                                        test_type = "continous",
                                        group = FALSE)

expl_var_age
```

### RIN

```{r}
expl_var_rin <- MOFAcellulaR::get_associations(model = model,
                                       metadata = meta,
                                        sample_id_column = "sample_id",
                                        test_variable = "RIN",
                                        test_type = "continous",
                                        group = FALSE)

expl_var_rin
```

### Batch

```{r}
expl_var_batch <- MOFAcellulaR::get_associations(model = model,
                                       metadata = meta,
                                        sample_id_column = "sample_id",
                                        test_variable = "Batch",
                                        test_type = "categorical",
                                        categorical_type = "parametric",
                                        group = FALSE)

expl_var_batch
```

## Explained variance per factor and summary heatmap

We recover the explained variance per view per factor to evaluate if coordinated gene expression processes are coordinated between all the cell types or exclusive to only a group of them

```{r, fig.width = 3.5}
assoc_list <- list(disease = expl_var_dis, 
                   lession = expl_var_lession,
                   sex = expl_var_sex,
                   age = expl_var_age,
                   rin = expl_var_rin,
                   batch = expl_var_batch)

col_list <- list(lesion_type = c("A" = "lightblue",
                                                    "CA" = "#FF6666", 
                                                    "CI"= "#3CB371",
                                                    "Ctrl" = "pink"),
                                  disease = c("Ctrl" = "black",
                                            "MS" = "darkgrey"))

scores_hmap <- MOFAcellulaR::plot_MOFA_hmap(model = model,
                group = FALSE,
                metadata = meta,
                sample_id_column = "sample_id",
                sample_anns = c("lesion_type", "disease"),
                assoc_list = assoc_list,
                col_rows = col_list)


pdf("./results/MOFAcell_summ.pdf", height = 6.5, width = 3.5)

draw(scores_hmap)

dev.off()
```

```{r}
MOFA2::get_factors(model)
```

```{r, fig.height=3, fig.width=3}
MOFAcellulaR::get_tidy_factors(model, meta,factor = "Factor1",sample_id_column = "sample_id") %>%
  ggplot(aes(x = lesion_type, y = value)) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  theme(axis.text = element_text(size = 10)) +
  ylab("Factor1")
```

```{r, fig.height=3, fig.width=3}
MOFAcellulaR::get_tidy_factors(model, meta,factor = "Factor2",sample_id_column = "sample_id") %>%
  ggplot(aes(x = lesion_type, y = value)) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  theme(axis.text = element_text(size = 10)) +
  ylab("Factor2")
```

```{r, fig.height=3, fig.width=3}
MOFAcellulaR::get_tidy_factors(model, meta,factor = "Factor3",sample_id_column = "sample_id") %>%
  ggplot(aes(x = lesion_type, y = value)) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  theme(axis.text = element_text(size = 10)) +
  ylab("Factor3")
```

```{r, fig.height=3, fig.width=3}
MOFAcellulaR::get_tidy_factors(model, meta,factor = "Factor4",sample_id_column = "sample_id") %>%
  ggplot(aes(x = lesion_type, y = value)) +
  geom_boxplot() +
  geom_point() +
  ylab("Factor4")
```

## Paper stats

### Number of features per view

```{r}
pb_dat_df %>%
  group_by(view, sample) %>%
  summarize(n_feat = n()) %>%
  dplyr::select(view, n_feat) %>%
  unique()
```

### Recovered mean across all samples
```{r}
model@cache$variance_explained$r2_total$single_group
model@cache$variance_explained$r2_total$single_group %>% mean()
```

```{r, fig.height=3, fig.width=3}
R2_f1 <- model@cache$variance_explained$r2_per_factor[[1]]["Factor1",] %>%
  enframe() %>%
  arrange(value)

R2_f1 <- R2_f1 %>%
  dplyr::mutate(name = factor(name,
                              levels = pull(R2_f1, name))) %>%
  dplyr::filter(name != "compositions")

ggplot(R2_f1, aes(x = value, y = name)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  ylab("") +
  xlab("Explained variance Factor 1") +
  theme(axis.text = element_text(size =10))
```

```{r, fig.height=3, fig.width=3}
R2_f3 <- model@cache$variance_explained$r2_per_factor[[1]]["Factor3",] %>%
  enframe() %>%
  arrange(value)

R2_f3 <- R2_f3 %>%
  dplyr::mutate(name = factor(name,
                              levels = pull(R2_f3, name))) %>%
  dplyr::filter(name != "compositions")

ggplot(R2_f3, aes(x = value, y = name)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  ylab("") +
  xlab("Explained variance Factor 3") +
  theme(axis.text = element_text(size =10))
```

```{r, fig.height=4, fig.width=5.3}

pdf("./results/MOFAcell_factorscatter.pdf", height = 3.2, width = 3.5)

MOFAcellulaR::get_tidy_factors(model, 
                               factor = "all", 
                               metadata = meta, 
                               sample_id_column = "sample_id") %>%
  dplyr::filter(Factor %in% c("Factor3", "Factor1")) %>%
  dplyr::select(sample, lesion_type, Factor, value) %>%
  pivot_wider(names_from = Factor, values_from = value) %>%
  ggplot(aes(x = Factor1, y = Factor3, color = lesion_type, label = sample)) +
  geom_point() +
  ggrepel::geom_text_repel(size = 3) +
  theme_classic() +
  theme(axis.text = element_text(size =10))

dev.off()

```

```{r}
pdf("./results/MOFAcell_UMAP.pdf", height = 3.2, width = 3.5)

MOFAcellulaR::plot_sample_2D(model, metadata = meta, sample_id_column = "sample_id",color_by = "lesion_type")

dev.off()
```

```{r}
pdf("./results/MOFAcell_MDS.pdf", height = 3.2, width = 3.5)

MOFAcellulaR::plot_sample_2D(model, metadata = meta, sample_id_column = "sample_id",color_by = "lesion_type", method = "MDS")

dev.off()
```
